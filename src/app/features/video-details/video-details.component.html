<div class="video-details-container">
    <div class="watch-comment-section">
        <div class='watch-section'>
            <div class="video-container">
                <video 
                    [src]="videoDetails?.videoPath" 
                    [attr.controls]="isSynchronizedPlaybackActive ? null : true"
                    (loadedmetadata)="onVideoLoadedMetadata()">
                </video>
                
                <!-- Countdown overlay for scheduled videos -->
                <div class="countdown-overlay" *ngIf="countdownMessage">
                    <div class="countdown-content">
                        <mat-icon>schedule</mat-icon>
                        <h2>Zakazan video - Sinhronizovani prikaz</h2>
                        <div class="scheduled-time">
                            <p class="start-label">Počinje:</p>
                            <p class="start-datetime">{{ getFormattedScheduledTime() }}</p>
                        </div>
                        <div class="countdown-timer">
                            <p class="countdown-label">Preostalo vreme:</p>
                            <p class="countdown-value">{{ countdownMessage }}</p>
                        </div>
                        <p class="countdown-hint">Video će automatski početi u zakazano vreme. Svi korisnici će gledati istu minutažu tokom trajanja videa. Nakon završetka, video postaje dostupan za normalan pregled sa kontrolama.</p>
                    </div>
                </div>
                
                <!-- Info badge for scheduled videos that have started -->
                <div class="scheduled-badge" *ngIf="isSynchronizedPlaybackActive && !countdownMessage">
                    <mat-icon>live_tv</mat-icon>
                    <span>UŽIVO - Sinhronizovani prikaz</span>
                </div>
                
                <!-- Info message below video during synchronized playback -->
                <div class="sync-info-message" *ngIf="isSynchronizedPlaybackActive && !countdownMessage">
                    <mat-icon>info</mat-icon>
                    <p>Ovaj video se trenutno prikazuje u sinhronizovanom režimu. Kontrole će biti dostupne nakon završetka prikaza.</p>
                </div>
            </div>

            <h1 class="video-title">{{videoDetails?.title}}</h1>

            <div class="tags" *ngIf="videoTags.length">
                <span class="tag-pill" *ngFor="let tag of videoTags">{{ tag }}</span>
            </div>
            <div class="watch-metadata">
                <span class="channel">
                    <mat-icon>person</mat-icon>
                    <a *ngIf="videoDetails?.authorUsername" [routerLink]="['/profile', videoDetails!.authorUsername]">
                      {{videoDetails?.authorUsername}}
                    </a>
                </span>

                <span class="watch-metadata-controls">
                    <span class="view-count">
                        <mat-icon>remove_red_eye</mat-icon> {{videoDetails?.viewCount}} 
                    </span>
                    <span class="created-date">
                        {{videoDetails?.createdAt | date:'dd.MM.yyyy'}}
                    </span>
                    <span class="like-dislike">
                        <span class="like" (click)="handleLike()" [class.liked]="likedByUser">
                            <mat-icon>{{ likedByUser ? 'thumb_up' : 'thumb_up_off_alt' }}</mat-icon>
                            <span class="like-count">{{ likeCount }}</span>
                        </span>
                    </span>
                    <span class="share">
                        <mat-icon>share</mat-icon>
                    </span>
                </span>
            </div>
            <div class="video-description">
                <h4>Opis</h4>
                <p>{{videoDetails?.description}}</p>
            </div>
        </div>
        <div class="comment-section">
            <h3 class="comment-title">Komentari</h3>
            
            <!-- Forma za dodavanje komentara -->
            <div class="add-comment">
                <textarea 
                    [formControl]="commentControl"
                    placeholder="Dodaj komentar..."
                    rows="3"
                    class="comment-input"
                ></textarea>
                <button 
                    (click)="submitComment()" 
                    [disabled]="commentControl.invalid"
                    class="comment-submit-btn"
                >
                    Komentariši
                </button>
            </div>

            <!-- Lista komentara -->
            <div class="comments-list">
                <div *ngIf="loadingComments" class="loading-comments">Učitavanje komentara...</div>
                
                <div *ngIf="!loadingComments && comments.length === 0" class="no-comments">
                    Nema komentara. Budite prvi koji će komentarisati!
                </div>

                <div *ngIf="comments.length > 0" class="comments-count">
                    Prikazano {{ comments.length }} od {{ totalComments }} komentara
                </div>

                <div *ngFor="let comment of comments" class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">
                            <mat-icon>account_circle</mat-icon>
                            <a [routerLink]="['/profile', comment.authorUsername]">
                                {{ comment.authorUsername }}
                            </a>
                        </span>
                        <span class="comment-time">{{ getTimeAgo(comment.createdAt) }}</span>
                    </div>
                    <div class="comment-content">{{ comment.content }}</div>
                    <div class="comment-actions" *ngIf="canDeleteComment(comment)">
                        <button (click)="deleteComment(comment.id)" class="delete-comment-btn">
                            <mat-icon>delete</mat-icon>
                            Obriši
                        </button>
                    </div>
                </div>

                <!-- Dugme za učitavanje više komentara -->
                <button 
                    *ngIf="totalCommentPages > 1 && commentPage < totalCommentPages - 1" 
                    (click)="loadMoreComments()"
                    class="load-more-btn"
                    [disabled]="loadingComments"
                >
                    Prikaži još komentara
                </button>
            </div>
        </div>
    </div>
    
    <div class="suggested-section">
        <div class="chat-section" *ngIf="isSynchronizedPlaybackActive && !countdownMessage && isLoggedIn">
            <h3>Chat ({{ username }})</h3>
            
            <div class="chat-messages">
            <div *ngFor="let msg of messages" 
                [class.own-message]="msg.username === username"
                class="message">
                <span class="username">{{ msg.username }}:</span>
                <span class="text">{{ msg.message }}</span>
                <span class="time">{{ msg.timestamp | date:'HH:mm' }}</span>
            </div>
            </div>

            <div class="chat-input">
            <input 
                type="text" 
                [(ngModel)]="newMessage"
                (keyup.enter)="sendMessage()"
                placeholder="Unesite poruku...">
            <button (click)="sendMessage()">Pošalji</button>
            </div>
        </div>

        <h2>Preporučujemo</h2>
        <div class="suggested-videos">
            <a
                class="suggested-card"
                *ngFor="let video of suggestedVideos"
                [routerLink]="['/watch', video.draftId]"
            >
                <div class="suggested-thumbnail">
                    <img
                        [src]="getThumbnailUrl(video.draftId)"
                        [alt]="video.title"
                    />
                </div>
                <div class="suggested-info">
                    <h3 class="suggested-title">{{ video.title }}</h3>
                    <p class="suggested-meta">
                        {{ video.authorUsername }} 
                        • {{ video.viewCount }} pregleda 
                        • {{ video.createdAt | date:'dd.MM.yyyy' }}
                    </p>
                </div>
            </a>
        </div>

        <!-- Load More Button -->
        <div class="load-more-suggested-container" *ngIf="hasMoreSuggested && !loadingSuggested">
            <button class="load-more-btn" (click)="loadMoreSuggestedVideos()">
                Prikaži još videa
            </button>
        </div>

        <!-- Loading indicator -->
        <div class="loading-suggested" *ngIf="loadingSuggested">
            <div class="loading-spinner"></div>
            <p>Učitavanje...</p>
        </div>

        <!-- End message -->
        <div class="end-message" *ngIf="!hasMoreSuggested && suggestedVideos.length > 0">
            <p>Prikazani su svi preporučeni videi</p>
        </div>
    </div>
</div>
